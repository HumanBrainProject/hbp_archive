<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>hbp_archive &#8212; hbp_archive 0.6.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.6.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">hbp_archive 0.6.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for hbp_archive</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2017-2018 CNRS</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#    http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or</span>
<span class="c1"># implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A high-level API for interacting with the Human Brain Project archival storage at CSCS.</span>

<span class="sd">Author: Andrew Davison and Shailesh Appukuttan, CNRS</span>

<span class="sd">License: Apache License, Version 2.0, see LICENSE.txt</span>

<span class="sd">Example Usage</span>
<span class="sd">=============</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    from hbp_archive import Container, PublicContainer, Project, Archive</span>


<span class="sd">    # Working with a public container</span>

<span class="sd">    container = PublicContainer(&quot;https://object.cscs.ch/v1/AUTH_id/my_container&quot;)</span>
<span class="sd">    files = container.list()</span>
<span class="sd">    local_file = container.download(&quot;README.txt&quot;)</span>
<span class="sd">    print(container.read(&quot;README.txt&quot;))</span>
<span class="sd">    number_of_files = container.count()</span>
<span class="sd">    size_in_MB = container.size(&quot;MB&quot;)</span>

<span class="sd">    # Working with a private container</span>

<span class="sd">    container = Container(&quot;MyContainer&quot;, username=&quot;xyzabc&quot;)  # you will be prompted for your password</span>
<span class="sd">    files = container.list()</span>
<span class="sd">    local_file = container.download(&quot;README.txt&quot;, overwrite=True)  # default is not to overwrite existing files</span>
<span class="sd">    print(container.read(&quot;README.txt&quot;))</span>
<span class="sd">    number_of_files = container.count()</span>
<span class="sd">    size_in_MB = container.size(&quot;MB&quot;)</span>

<span class="sd">    container.move(&quot;my_file.dat&quot;, &quot;a_subdirectory&quot;, &quot;new_name.dat&quot;)  # move/rename file within a container</span>

<span class="sd">    # Reading a file directly, without downloading it</span>

<span class="sd">    with container.open(&quot;my_data.txt&quot;) as fp:</span>
<span class="sd">        data = np.loadtxt(fp)</span>

<span class="sd">    # Working with a project</span>

<span class="sd">    my_proj = Project(&#39;MyProject&#39;, username=&quot;xyzabc&quot;)</span>
<span class="sd">    container = my_proj.get_container(&quot;MyContainer&quot;)</span>

<span class="sd">    # Listing all your projects</span>

<span class="sd">    archive = Archive(username=&quot;xyzabc&quot;)</span>
<span class="sd">    projects = archive.projects</span>
<span class="sd">    container = archive.find_container(&quot;MyContainer&quot;)  # will search through all projects</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">keystoneauth1.identity</span> <span class="k">import</span> <span class="n">v3</span>
<span class="kn">from</span> <span class="nn">keystoneauth1</span> <span class="k">import</span> <span class="n">session</span>
<span class="kn">from</span> <span class="nn">keystoneauth1.exceptions.auth</span> <span class="k">import</span> <span class="n">AuthorizationFailure</span>
<span class="kn">from</span> <span class="nn">keystoneauth1.extras._saml2</span> <span class="k">import</span> <span class="n">V3Saml2Password</span>
<span class="kn">from</span> <span class="nn">keystoneclient.v3</span> <span class="k">import</span> <span class="n">client</span> <span class="k">as</span> <span class="n">ksclient</span>
<span class="kn">import</span> <span class="nn">swiftclient.client</span> <span class="k">as</span> <span class="nn">swiftclient</span>
<span class="kn">from</span> <span class="nn">swiftclient.exceptions</span> <span class="k">import</span> <span class="n">ClientException</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">Path</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pathlib2</span> <span class="k">import</span> <span class="n">Path</span>  <span class="c1"># Python 2 backport</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.6.0&quot;</span>

<span class="n">OS_AUTH_URL</span> <span class="o">=</span> <span class="s1">&#39;https://pollux.cscs.ch:13000/v3&#39;</span>
<span class="n">OS_IDENTITY_PROVIDER</span> <span class="o">=</span> <span class="s1">&#39;cscskc&#39;</span>
<span class="n">OS_IDENTITY_PROVIDER_URL</span> <span class="o">=</span> <span class="s1">&#39;https://kc.cscs.ch/auth/realms/cscs/protocol/saml/&#39;</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;hbp_archive&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">scale_bytes</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a value in bytes to a different unit&quot;&quot;&quot;</span>
    <span class="n">allowed_units</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;bytes&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;kB&#39;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
        <span class="s1">&#39;MB&#39;</span><span class="p">:</span> <span class="mi">1048576</span><span class="p">,</span>
        <span class="s1">&#39;GB&#39;</span><span class="p">:</span> <span class="mi">1073741824</span><span class="p">,</span>
        <span class="s1">&#39;TB&#39;</span><span class="p">:</span> <span class="mi">1099511627776</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">units</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_units</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Units must be one of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">allowed_units</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">allowed_units</span><span class="p">[</span><span class="n">units</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">value</span> <span class="o">/</span> <span class="n">scale</span>


<div class="viewcode-block" id="File"><a class="viewcode-back" href="../index.html#hbp_archive.File">[docs]</a><span class="k">class</span> <span class="nc">File</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A representation of a file in a container.</span>

<span class="sd">    The following actions can be performed:</span>

<span class="sd">    ====================================   ====================================</span>
<span class="sd">    Action                                 Method</span>
<span class="sd">    ====================================   ====================================</span>
<span class="sd">    Download a file                        :meth:`download`</span>
<span class="sd">    Read contents of a file                :meth:`read`</span>
<span class="sd">    Move a file                            :meth:`move`</span>
<span class="sd">    Rename a file                          :meth:`rename`</span>
<span class="sd">    Copy a file                            :meth:`copy`</span>
<span class="sd">    Delete a file                          :meth:`delete`</span>
<span class="sd">    Get size of file                       :meth:`size`</span>
<span class="sd">    ====================================   ====================================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="nb">hash</span><span class="p">,</span> <span class="n">last_modified</span><span class="p">,</span> <span class="n">container</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="nb">bytes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="n">content_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hash</span> <span class="o">=</span> <span class="nb">hash</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_modified</span> <span class="o">=</span> <span class="n">last_modified</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span> <span class="o">=</span> <span class="n">container</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dirname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">basename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="File.download"><a class="viewcode-back" href="../index.html#hbp_archive.File.download">[docs]</a>    <span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_directory</span><span class="p">,</span> <span class="n">with_tree</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Download this file to a local directory.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        local_directory : string</span>
<span class="sd">            Local directory path where file is to be saved.</span>
<span class="sd">        with_tree : boolean, optional</span>
<span class="sd">            Specify if directory structure of file is to be retained.</span>
<span class="sd">        overwrite : boolean, optional</span>
<span class="sd">            Specify if any already existing file should be overwritten.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">local_directory</span><span class="o">=</span><span class="n">local_directory</span><span class="p">,</span> <span class="n">with_tree</span><span class="o">=</span><span class="n">with_tree</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Parent container not known, unable to download&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="File.read"><a class="viewcode-back" href="../index.html#hbp_archive.File.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">decode</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">accept</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;Read and return the contents of this file in the container.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_path : string</span>
<span class="sd">            Path of file to be retrieved.</span>
<span class="sd">        decode : string, optional</span>
<span class="sd">            Files containing text will be decoded using specified encoding</span>
<span class="sd">            (default: &#39;utf-8&#39;). To prevent any attempt at decoding, set `decode=False`.</span>
<span class="sd">        accept : boolean, optional</span>
<span class="sd">            To force decoding, put the expected content type in `accept`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">decode</span><span class="o">=</span><span class="n">decode</span><span class="p">,</span> <span class="n">accept</span><span class="o">=</span><span class="n">accept</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Parent container not known, unable to read file contents&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="File.move"><a class="viewcode-back" href="../index.html#hbp_archive.File.move">[docs]</a>    <span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_directory</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Move this file to the specified directory.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_directory : string</span>
<span class="sd">            Target directory where the file is to be moved.</span>
<span class="sd">        new_name : string, optional</span>
<span class="sd">            New name to be assigned to file (including extension, if any).</span>
<span class="sd">        overwrite : boolean, optional</span>
<span class="sd">            Specify if any already existing file should be overwritten.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">target_directory</span><span class="o">=</span><span class="n">target_directory</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="n">new_name</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Parent container not known, unable to move&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="File.rename"><a class="viewcode-back" href="../index.html#hbp_archive.File.rename">[docs]</a>    <span class="k">def</span> <span class="nf">rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_name</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rename this file within the source directory.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        new_name : string</span>
<span class="sd">            New name to be assigned to file (including extension, if any).</span>
<span class="sd">        overwrite : boolean, optional</span>
<span class="sd">            Specify if any already existing file should be overwritten.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">target_directory</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">new_name</span><span class="o">=</span><span class="n">new_name</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span></div>

<div class="viewcode-block" id="File.copy"><a class="viewcode-back" href="../index.html#hbp_archive.File.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_directory</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy this file to specified directory.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_directory : string</span>
<span class="sd">            Target directory where the file is to be copied.</span>
<span class="sd">        new_name : string, optional</span>
<span class="sd">            New name to be assigned to file (including extension, if any).</span>
<span class="sd">        overwrite : boolean, optional</span>
<span class="sd">            Specify if any already existing file at target location should be overwritten.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">target_directory</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">new_name</span><span class="o">=</span><span class="n">new_name</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span></div>

<div class="viewcode-block" id="File.delete"><a class="viewcode-back" href="../index.html#hbp_archive.File.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete this file.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="File.size"><a class="viewcode-back" href="../index.html#hbp_archive.File.size">[docs]</a>    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;bytes&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the size of this file in the requested unit (default bytes).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        units : string</span>
<span class="sd">            Requested units for output.</span>
<span class="sd">            Options: &#39;bytes&#39; (default), &#39;kB&#39;, &#39;MB&#39;, &#39;GB&#39;, &#39;TB&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">scale_bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bytes</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Container"><a class="viewcode-back" href="../index.html#hbp_archive.Container">[docs]</a><span class="k">class</span> <span class="nc">Container</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A representation of a CSCS storage container. Can be used to operate both</span>
<span class="sd">    public and private CSCS containers. A CSCS account is needed to use this class.</span>

<span class="sd">    The following actions can be performed:</span>

<span class="sd">    ====================================   ====================================</span>
<span class="sd">    Action                                 Method</span>
<span class="sd">    ====================================   ====================================</span>
<span class="sd">    List all files in container            :meth:`list`</span>
<span class="sd">    Return a file from given path          :meth:`get`</span>
<span class="sd">    Get number of files in container       :meth:`count`</span>
<span class="sd">    Get total size of data in container    :meth:`size`</span>
<span class="sd">    Upload file(s) to container            :meth:`upload`</span>
<span class="sd">    Download a file from container         :meth:`download`</span>
<span class="sd">    Read contents of file in container     :meth:`read`</span>
<span class="sd">    Copy a file in container               :meth:`copy`</span>
<span class="sd">    Move a file in container               :meth:`move`</span>
<span class="sd">    Delete a file in container             :meth:`delete`</span>
<span class="sd">    Copy a directory in container          :meth:`copy_directory`</span>
<span class="sd">    Move a directory in container          :meth:`move_directory`</span>
<span class="sd">    Delete a directory  in container       :meth:`delete_directory`</span>
<span class="sd">    List users with access to container    :meth:`access_control`</span>
<span class="sd">    Grant container access to user         :meth:`grant_access`</span>
<span class="sd">    ====================================   ====================================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">project</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">archive</span> <span class="o">=</span> <span class="n">Archive</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
            <span class="n">project</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">find_container</span><span class="p">(</span><span class="n">container</span><span class="p">)</span><span class="o">.</span><span class="n">project</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">project</span> <span class="o">=</span> <span class="n">Project</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">container</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Container(&#39;</span><span class="si">{}</span><span class="s2">&#39;, project=&#39;</span><span class="si">{}</span><span class="s2">&#39;, username=&#39;</span><span class="si">{}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Metadata about the container&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">head_container</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span>

<div class="viewcode-block" id="Container.list"><a class="viewcode-back" href="../index.html#hbp_archive.Container.list">[docs]</a>    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># , content_type=None, newer_than=None, older_than=None):</span>
        <span class="sd">&quot;&quot;&quot;List all files in the container.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">,</span> <span class="n">contents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">get_container</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">File</span><span class="p">(</span><span class="n">container</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">]</span></div>

<div class="viewcode-block" id="Container.get"><a class="viewcode-back" href="../index.html#hbp_archive.Container.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a File object for the file at the given path.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_path : string</span>
<span class="sd">            Path of file to be retrieved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">():</span>  <span class="c1"># very inefficient</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">file_path</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">f</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Path &#39;</span><span class="si">{}</span><span class="s2">&#39; does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span></div>

<div class="viewcode-block" id="Container.count"><a class="viewcode-back" href="../index.html#hbp_archive.Container.count">[docs]</a>    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of files in the container&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;x-container-object-count&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="Container.size"><a class="viewcode-back" href="../index.html#hbp_archive.Container.size">[docs]</a>    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;bytes&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Total size of all data in the container</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        units : string</span>
<span class="sd">            Requested units for output.</span>
<span class="sd">            Options: &#39;bytes&#39; (default), &#39;kB&#39;, &#39;MB&#39;, &#39;GB&#39;, &#39;TB&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">scale_bytes</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;x-container-bytes-used&#39;</span><span class="p">]),</span> <span class="n">units</span><span class="p">)</span></div>

<div class="viewcode-block" id="Container.upload"><a class="viewcode-back" href="../index.html#hbp_archive.Container.upload">[docs]</a>    <span class="k">def</span> <span class="nf">upload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_paths</span><span class="p">,</span> <span class="n">remote_directory</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Upload file(s) to the container.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        local_paths : string, list of strings</span>
<span class="sd">            Local path of file(s) to be uploaded.</span>
<span class="sd">        remote_directory : string, optional</span>
<span class="sd">            Remote directory path where data is to be uploaded. Default is root directory.</span>
<span class="sd">        overwrite : boolean, optional</span>
<span class="sd">            Specify if any already existing file at target should be overwritten.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        Using the command-line &quot;swift upload&quot; will likely be faster since</span>
<span class="sd">        it uses a pool of threads to perform multiple uploads in parallel.</span>
<span class="sd">        It is thus recommended for bulk uploads.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">local_paths</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">local_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">local_paths</span><span class="p">]</span>
        <span class="n">remote_paths</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">local_paths</span><span class="p">:</span>
            <span class="n">remote_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_directory</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">head_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">remote_path</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Target file path already exists! Set `overwrite=True` to overwrite file.&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>            <span class="c1"># if file already exists</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;File: </span><span class="si">{}</span><span class="s2"> not uploaded. Reason: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                    <span class="k">return</span>
                <span class="k">except</span> <span class="n">ClientException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>    <span class="c1"># if file does not exist</span>
                    <span class="k">pass</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">file_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">put_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">remote_path</span><span class="p">,</span> <span class="n">file_data</span><span class="p">)</span>
                <span class="n">remote_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">remote_paths</span></div>

<div class="viewcode-block" id="Container.download"><a class="viewcode-back" href="../index.html#hbp_archive.Container.download">[docs]</a>    <span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">local_directory</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">with_tree</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Download a file from the container.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_path : string</span>
<span class="sd">            Path of file to be downloaded.</span>
<span class="sd">        local_directory : string, optional</span>
<span class="sd">            Local directory path where file is to be saved.</span>
<span class="sd">        with_tree : boolean, optional</span>
<span class="sd">            Specify if directory structure of file is to be retained.</span>
<span class="sd">        overwrite : boolean, optional</span>
<span class="sd">            Specify if any already existing file should be overwritten.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># todo: allow file_path to be a File object</span>
        <span class="n">headers</span><span class="p">,</span> <span class="n">contents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">with_tree</span><span class="p">:</span>
            <span class="n">local_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">local_directory</span><span class="p">),</span>
                                           <span class="o">*</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">local_directory</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_directory</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Destination file (</span><span class="si">{}</span><span class="s2">) already exists! Set `overwrite=True` to overwrite file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">local_path</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">local</span><span class="p">:</span>
            <span class="n">local</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">local_path</span></div>
        <span class="c1"># todo: check hash</span>

<div class="viewcode-block" id="Container.read"><a class="viewcode-back" href="../index.html#hbp_archive.Container.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">decode</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">accept</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;Read and return the contents of a file in the container.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_path : string</span>
<span class="sd">            Path of file to be retrieved.</span>
<span class="sd">        decode : string, optional</span>
<span class="sd">            Files containing text will be decoded using specified encoding</span>
<span class="sd">            (default: &#39;utf-8&#39;). To prevent any attempt at decoding, set `decode=False`.</span>
<span class="sd">        accept : boolean, optional</span>
<span class="sd">            To force decoding, put the expected content type in `accept`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">text_content_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span> <span class="p">]</span>
        <span class="n">headers</span><span class="p">,</span> <span class="n">contents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
        <span class="c1"># todo: check hash</span>
        <span class="n">content_type</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;content-type&quot;</span><span class="p">]</span>
        <span class="n">ct_parts</span> <span class="o">=</span> <span class="n">content_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ct_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span> <span class="ow">or</span> <span class="n">content_type</span> <span class="ow">in</span> <span class="n">text_content_types</span> <span class="ow">or</span> <span class="n">content_type</span> <span class="ow">in</span> <span class="n">accept</span><span class="p">)</span> <span class="ow">and</span> <span class="n">decode</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">contents</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">decode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">contents</span></div>

<div class="viewcode-block" id="Container.copy"><a class="viewcode-back" href="../index.html#hbp_archive.Container.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">target_directory</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy a file to the specified directory.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_path : string</span>
<span class="sd">            Path of file to be copied.</span>
<span class="sd">        target_directory : string</span>
<span class="sd">            Target directory where the file is to be copied.</span>
<span class="sd">        new_name : string, optional</span>
<span class="sd">            New name to be assigned to file (including extension, if any).</span>
<span class="sd">        overwrite : boolean, optional</span>
<span class="sd">            Specify if any already existing file should be overwritten.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_name</span><span class="p">:</span>
            <span class="n">new_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">head_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_directory</span><span class="p">,</span> <span class="n">new_name</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Target file path already exists! Set `overwrite=True` to overwrite file.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">except</span> <span class="n">ClientException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">copy_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">destination</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">target_directory</span><span class="p">,</span> <span class="n">new_name</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully copied the object&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ClientException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Failed to copy the object with error: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span></div>

<div class="viewcode-block" id="Container.move"><a class="viewcode-back" href="../index.html#hbp_archive.Container.move">[docs]</a>    <span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">target_directory</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Move a file to the specified directory.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_path : string</span>
<span class="sd">            Path of file to be moved.</span>
<span class="sd">        target_directory : string</span>
<span class="sd">            Target directory where the file is to be moved.</span>
<span class="sd">        new_name : string, optional</span>
<span class="sd">            New name to be assigned to file (including extension, if any).</span>
<span class="sd">        overwrite : boolean, optional</span>
<span class="sd">            Specify if any already existing file should be overwritten.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_name</span><span class="p">:</span>
            <span class="n">new_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">head_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_directory</span><span class="p">,</span> <span class="n">new_name</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Target file path already exists! Set `overwrite=True` to overwrite file.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">except</span> <span class="n">ClientException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">copy_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">destination</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">target_directory</span><span class="p">,</span> <span class="n">new_name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">delete_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="o">==</span> <span class="n">target_directory</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully renamed the object&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully moved the object&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ClientException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to move/rename the object with error: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span></div>

<div class="viewcode-block" id="Container.delete"><a class="viewcode-back" href="../index.html#hbp_archive.Container.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete the specified file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_path : string</span>
<span class="sd">            Path of file to be deleted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">delete_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully deleted the object&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ClientException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to delete the object with error: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span></div>

<div class="viewcode-block" id="Container.copy_directory"><a class="viewcode-back" href="../index.html#hbp_archive.Container.copy_directory">[docs]</a>    <span class="k">def</span> <span class="nf">copy_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory_path</span><span class="p">,</span> <span class="n">target_directory</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy a directory to the specified directory location.</span>
<span class="sd">           The original tree structure of the directory will be maintained at</span>
<span class="sd">           the target location.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        directory_path : string</span>
<span class="sd">            Path of directory to be copied.</span>
<span class="sd">        target_directory : string</span>
<span class="sd">            Path of target directory where specified directory is to be copied.</span>
<span class="sd">        new_name : string, optional</span>
<span class="sd">            New name to be assigned to directory.</span>
<span class="sd">        overwrite : boolean, optional</span>
<span class="sd">            Specify if any already existing files at target location should be</span>
<span class="sd">            overwritten. If False (default value), then only non-conflicting</span>
<span class="sd">            files will be copied over.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">directory_path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
            <span class="n">directory_path</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_name</span><span class="p">:</span>
            <span class="n">new_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">directory_path</span><span class="p">)</span>
        <span class="n">all_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="n">dir_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">directory_path</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dir_files</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Specified directory does not exist in this container!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;***** Directory Copy Details *****&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">dir_files</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_directory</span><span class="p">,</span> <span class="n">new_name</span><span class="p">),</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span></div>

<div class="viewcode-block" id="Container.move_directory"><a class="viewcode-back" href="../index.html#hbp_archive.Container.move_directory">[docs]</a>    <span class="k">def</span> <span class="nf">move_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory_path</span><span class="p">,</span> <span class="n">target_directory</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Move a directory to the specified directory location.</span>
<span class="sd">           Can also be used to rename a directory.</span>
<span class="sd">           The original tree structure of the directory will be maintained at</span>
<span class="sd">           the target location.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        directory_path : string</span>
<span class="sd">            Path of directory to be copied.</span>
<span class="sd">        target_directory : string</span>
<span class="sd">            Path of target directory where specified directory is to be copied.</span>
<span class="sd">        new_name : string, optional</span>
<span class="sd">            New name to be assigned to directory.</span>
<span class="sd">        overwrite : boolean, optional</span>
<span class="sd">            Specify if any already existing files at target location should be</span>
<span class="sd">            overwritten. If False (default value), then only non-conflicting</span>
<span class="sd">            files will be copied over.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">directory_path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
            <span class="n">directory_path</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_name</span><span class="p">:</span>
            <span class="n">new_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">directory_path</span><span class="p">)</span>
        <span class="n">all_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="n">dir_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">directory_path</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dir_files</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Specified directory does not exist in this container!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;***** Directory Move Details *****&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">dir_files</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_directory</span><span class="p">,</span> <span class="n">new_name</span><span class="p">),</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span></div>

<div class="viewcode-block" id="Container.delete_directory"><a class="viewcode-back" href="../index.html#hbp_archive.Container.delete_directory">[docs]</a>    <span class="k">def</span> <span class="nf">delete_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete the specified directory (and its contents).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        directory_path : string</span>
<span class="sd">            Path of directory to be deleted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">directory_path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
            <span class="n">directory_path</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span>
        <span class="n">all_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="n">dir_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">directory_path</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dir_files</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Specified directory does not exist in this container!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;***** Directory Delete Details *****&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">dir_files</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Filename: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Container.access_control"><a class="viewcode-back" href="../index.html#hbp_archive.Container.access_control">[docs]</a>    <span class="k">def</span> <span class="nf">access_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show_usernames</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List the users that have access to this container.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        show_usernames : boolean, optional</span>
<span class="sd">            default is `True`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">acl</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;read&quot;</span><span class="p">,</span> <span class="s2">&quot;write&quot;</span><span class="p">):</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x-container-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="n">acl</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
        <span class="k">if</span> <span class="n">show_usernames</span><span class="p">:</span>  <span class="c1"># map user id to username</span>
            <span class="n">user_id_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">users</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;read&quot;</span><span class="p">,</span> <span class="s2">&quot;write&quot;</span><span class="p">):</span>
                <span class="n">is_public</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">user_ids</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">acl</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;.r:*&#39;</span><span class="p">,</span> <span class="s1">&#39;.rlistings&#39;</span><span class="p">):</span>
                        <span class="n">is_public</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">user_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># each item is &quot;project:user_id&quot;</span>
                <span class="n">acl</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">user_id_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="n">user_ids</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">is_public</span><span class="p">:</span>
                    <span class="n">acl</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;PUBLIC&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">acl</span></div>

<div class="viewcode-block" id="Container.grant_access"><a class="viewcode-back" href="../index.html#hbp_archive.Container.grant_access">[docs]</a>    <span class="k">def</span> <span class="nf">grant_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;read&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Give read or write access to the given user.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        username : string</span>
<span class="sd">            username of user to be granted access</span>
<span class="sd">        mode : string, optional</span>
<span class="sd">            the access permission to be granted; default = &#39;read&#39;</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        Use restricted to Superusers/Operators.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">name_map</span><span class="p">[</span><span class="n">username</span><span class="p">]</span>
        <span class="n">new_acl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_control</span><span class="p">(</span><span class="n">show_usernames</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span>
            <span class="n">mode</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)]</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x-container-</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_acl</span><span class="p">)}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">post_container</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># needs to be refreshed</span></div></div>


<div class="viewcode-block" id="PublicContainer"><a class="viewcode-back" href="../index.html#hbp_archive.PublicContainer">[docs]</a><span class="k">class</span> <span class="nc">PublicContainer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>  <span class="c1"># todo: figure out inheritance relationship with Container</span>
    <span class="sd">&quot;&quot;&quot;A representation of a public CSCS storage container. Can be used to operate</span>
<span class="sd">    only public CSCS containers. A CSCS account is not needed to use this class.</span>

<span class="sd">    The following actions can be performed:</span>

<span class="sd">    ====================================   ====================================</span>
<span class="sd">    Action                                 Method</span>
<span class="sd">    ====================================   ====================================</span>
<span class="sd">    List all files in container            :meth:`list`</span>
<span class="sd">    Return a file from given path          :meth:`get`</span>
<span class="sd">    Get number of files in container       :meth:`count`</span>
<span class="sd">    Get total size of data in container    :meth:`size`</span>
<span class="sd">    Download a file from container         :meth:`download`</span>
<span class="sd">    Read contents of file in container     :meth:`read`</span>
<span class="sd">    ====================================   ====================================</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    This class only permits read-only operations. For other features,</span>
<span class="sd">    you may access a public container via the :class:`Container` class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_content_list</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;PublicContainer(&#39;</span><span class="si">{}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

<div class="viewcode-block" id="PublicContainer.list"><a class="viewcode-back" href="../index.html#hbp_archive.PublicContainer.list">[docs]</a>    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># todo: allow refreshing, in case contents have changed</span>
        <span class="sd">&quot;&quot;&quot;List all files in the container.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_content_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">File</span><span class="p">(</span><span class="n">container</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">entry</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content_list</span></div>

<div class="viewcode-block" id="PublicContainer.get"><a class="viewcode-back" href="../index.html#hbp_archive.PublicContainer.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a File object for the file at the given path.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_path : string</span>
<span class="sd">            Path of file to be retrieved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">():</span>  <span class="c1"># very inefficient</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">file_path</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">f</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Path &#39;</span><span class="si">{}</span><span class="s2">&#39; does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span></div>

<div class="viewcode-block" id="PublicContainer.count"><a class="viewcode-back" href="../index.html#hbp_archive.PublicContainer.count">[docs]</a>    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of files in the container&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">())</span></div>

<div class="viewcode-block" id="PublicContainer.size"><a class="viewcode-back" href="../index.html#hbp_archive.PublicContainer.size">[docs]</a>    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;bytes&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Total size of all data in the container</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        units : string</span>
<span class="sd">            Requested units for output.</span>
<span class="sd">            Options: &#39;bytes&#39; (default), &#39;kB&#39;, &#39;MB&#39;, &#39;GB&#39;, &#39;TB&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">total_bytes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">bytes</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">scale_bytes</span><span class="p">(</span><span class="n">total_bytes</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span></div>

<div class="viewcode-block" id="PublicContainer.download"><a class="viewcode-back" href="../index.html#hbp_archive.PublicContainer.download">[docs]</a>    <span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">local_directory</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">with_tree</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Download a file from the container.</span>

<span class="sd">        file_path : string</span>
<span class="sd">            Path of file to be downloaded.</span>
<span class="sd">        local_directory : string, optional</span>
<span class="sd">            Local directory path where file is to be saved.</span>
<span class="sd">        with_tree : boolean, optional</span>
<span class="sd">            Specify if directory structure of file is to be retained.</span>
<span class="sd">        overwrite : boolean, optional</span>
<span class="sd">            Specify if any already existing file should be overwritten.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># todo: allow file_path to be a File object</span>
        <span class="c1"># todo: implement direct streaming to file without</span>
        <span class="c1">#       storing copy in memory, see for example</span>
        <span class="c1">#       https://stackoverflow.com/questions/13137817/how-to-download-image-using-requests</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">file_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">with_tree</span><span class="p">:</span>
            <span class="n">local_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">local_directory</span><span class="p">),</span>
                                           <span class="o">*</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">local_directory</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_directory</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Destination file (</span><span class="si">{}</span><span class="s2">) already exists! Set `overwrite=True` to overwrite file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">local_path</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">local</span><span class="p">:</span>
            <span class="n">local</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">local_path</span></div>
        <span class="c1"># todo: check hash</span>

<div class="viewcode-block" id="PublicContainer.read"><a class="viewcode-back" href="../index.html#hbp_archive.PublicContainer.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">decode</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">accept</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;Read and return the contents of a file in the container.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_path : string</span>
<span class="sd">            Path of file to be retrieved.</span>
<span class="sd">        decode : string, optional</span>
<span class="sd">            Files containing text will be decoded using specified encoding</span>
<span class="sd">            (default: &#39;utf-8&#39;). To prevent any attempt at decoding, set `decode=False`.</span>
<span class="sd">        accept : boolean, optional</span>
<span class="sd">            To force decoding, put the expected content type in `accept`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">text_content_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span> <span class="p">]</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">file_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="c1"># todo: check hash</span>
        <span class="n">content_type</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;;&quot;</span> <span class="ow">in</span> <span class="n">content_type</span><span class="p">:</span>
            <span class="n">content_type</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="n">content_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
            <span class="c1"># todo: handle conflict between encoding and &quot;decode&quot; argument</span>
        <span class="n">ct_parts</span> <span class="o">=</span> <span class="n">content_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ct_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span> <span class="ow">or</span> <span class="n">content_type</span> <span class="ow">in</span> <span class="n">text_content_types</span> <span class="ow">or</span> <span class="n">content_type</span> <span class="ow">in</span> <span class="n">accept</span><span class="p">)</span> <span class="ow">and</span> <span class="n">decode</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">contents</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">decode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">contents</span></div></div>


<div class="viewcode-block" id="Project"><a class="viewcode-back" href="../index.html#hbp_archive.Project">[docs]</a><span class="k">class</span> <span class="nc">Project</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A representation of a CSCS Project.</span>

<span class="sd">    The following actions can be performed:</span>

<span class="sd">    ====================================   ====================================</span>
<span class="sd">    Action                                 Method / Property</span>
<span class="sd">    ====================================   ====================================</span>
<span class="sd">    Get a container from project           :meth:`get_container`</span>
<span class="sd">    List containers that you can access    :attr:`containers`</span>
<span class="sd">    Get names of containers in project     :attr:`container_names`</span>
<span class="sd">    Get mapping of usernames to user ids   :attr:`users`</span>
<span class="sd">    ====================================   ====================================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">archive</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">archive</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">archive</span> <span class="o">=</span> <span class="n">Archive</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
        <span class="n">ks_project</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">_ks_projects</span><span class="p">[</span><span class="n">project</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">archive</span> <span class="o">=</span> <span class="n">archive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">ks_project</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">ks_project</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__connection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_containers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_id_map</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Project(&#39;</span><span class="si">{}</span><span class="s2">&#39;, username=&#39;</span><span class="si">{}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__connection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_scope</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__connection</span> <span class="o">=</span> <span class="n">swiftclient</span><span class="o">.</span><span class="n">Connection</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__connection</span>

    <span class="k">def</span> <span class="nf">_set_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">auth</span> <span class="o">=</span> <span class="n">v3</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">auth_url</span><span class="o">=</span><span class="n">OS_AUTH_URL</span><span class="p">,</span>
                        <span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">get_token</span><span class="p">(),</span>
                        <span class="n">project_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">auth</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_container_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">,</span> <span class="n">containers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">get_account</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">ClientException</span><span class="p">:</span>
            <span class="n">containers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">containers</span>

<div class="viewcode-block" id="Project.get_container"><a class="viewcode-back" href="../index.html#hbp_archive.Project.get_container">[docs]</a>    <span class="k">def</span> <span class="nf">get_container</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a container from project</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : string</span>
<span class="sd">            name of the container to be retrieved</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">containers</span><span class="p">:</span>
            <span class="n">container</span> <span class="o">=</span> <span class="n">Container</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">container</span><span class="o">.</span><span class="n">metadata</span>  <span class="c1"># check that we can connect to the container</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_containers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">container</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">containers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">containers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Containers you have access to in this project.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_containers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_containers</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">Container</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">container_names</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_versions&quot;</span><span class="p">)}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_containers</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">container_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of container names&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_container_info</span><span class="p">()]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">users</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a mapping from usernames to user ids&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_id_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_user_id_map</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">proj_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">containers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;project_info&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">proj_info</span><span class="p">:</span>
                <span class="n">user_id_doc</span> <span class="o">=</span> <span class="n">proj_info</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;user_ids&#39;</span><span class="p">,</span> <span class="n">accept</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;application/octet-stream&#39;</span><span class="p">])</span>
                <span class="n">in_user_list</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">user_id_doc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">line</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;# user ids&quot;</span><span class="p">):</span>
                            <span class="n">in_user_list</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">elif</span> <span class="n">in_user_list</span><span class="p">:</span>
                            <span class="n">user_id</span><span class="p">,</span> <span class="n">username</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_user_id_map</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">username</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_id_map</span></div>


<div class="viewcode-block" id="Archive"><a class="viewcode-back" href="../index.html#hbp_archive.Archive">[docs]</a><span class="k">class</span> <span class="nc">Archive</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A representation of the Human Brain Project archival storage</span>
<span class="sd">    (Pollux SWIFT) at CSCS.</span>

<span class="sd">    The following actions can be performed:</span>

<span class="sd">    ====================================   ====================================</span>
<span class="sd">    Action                                 Method / Property</span>
<span class="sd">    ====================================   ====================================</span>
<span class="sd">    List projects that you can access      :attr:`projects`</span>
<span class="sd">    Search for container in all projects   :meth:`find_container`</span>
<span class="sd">    ====================================   ====================================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
            <span class="n">auth</span> <span class="o">=</span> <span class="n">v3</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">auth_url</span><span class="o">=</span><span class="n">OS_AUTH_URL</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CSCS_PASS&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pwd</span><span class="p">:</span>
                <span class="n">pwd</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span><span class="s2">&quot;Password: &quot;</span><span class="p">)</span>
            <span class="n">auth</span> <span class="o">=</span> <span class="n">V3Saml2Password</span><span class="p">(</span><span class="n">auth_url</span><span class="o">=</span><span class="n">OS_AUTH_URL</span><span class="p">,</span>
                                   <span class="n">identity_provider</span><span class="o">=</span><span class="n">OS_IDENTITY_PROVIDER</span><span class="p">,</span>
                                   <span class="n">protocol</span><span class="o">=</span><span class="s1">&#39;mapped&#39;</span><span class="p">,</span>
                                   <span class="n">identity_provider_url</span><span class="o">=</span><span class="n">OS_IDENTITY_PROVIDER_URL</span><span class="p">,</span>
                                   <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
                                   <span class="n">password</span><span class="o">=</span><span class="n">pwd</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">auth</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">ksclient</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">,</span> <span class="n">interface</span><span class="o">=</span><span class="s1">&#39;public&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">get_user_id</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">AuthorizationFailure</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t authenticate! Incorrect username.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t authenticate! Incorrect password.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ks_projects</span> <span class="o">=</span> <span class="p">{</span><span class="n">ksprj</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">ksprj</span>
                             <span class="k">for</span> <span class="n">ksprj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">projects</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_projects</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">projects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Projects you have access to&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_projects</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_projects</span> <span class="o">=</span> <span class="p">{</span><span class="n">ksprj_name</span><span class="p">:</span> <span class="n">Project</span><span class="p">(</span><span class="n">ksprj_name</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">archive</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">ksprj_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ks_projects</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_projects</span>

<div class="viewcode-block" id="Archive.find_container"><a class="viewcode-back" href="../index.html#hbp_archive.Archive.find_container">[docs]</a>    <span class="k">def</span> <span class="nf">find_container</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Search through all projects for the container with the given name.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : string</span>
<span class="sd">            name of the container to be searched</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `Container`</span>
<span class="sd">            Requested `Container` object. If not found, Exception raised.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">project</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">projects</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">project</span><span class="o">.</span><span class="n">get_container</span><span class="p">(</span><span class="n">container</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ClientException</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Container </span><span class="si">{}</span><span class="s2"> not found. Please check your access permissions.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">container</span><span class="p">))</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">hbp_archive 0.6.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Andrew Davison and Shailesh Appukuttan.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.1.
    </div>
  </body>
</html>